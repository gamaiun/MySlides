<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>MySlide</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:;"
    />
    <style>
      @media print {
  /* --- General Page Setup --- */
  html,
  body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    box-sizing: border-box;
  }

  /* --- Layout Containers --- */
  #layout {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding-top: 80px; /* Move padding here */
  }

#imageContainer {
  position: relative;
  top: 80px; /* Push down by 80px */
  width: 100%;
  height: calc(100% - 80px); /* Adjust height to reach the bottom */
  overflow: hidden !important;
}

  /* --- Components --- */
  .overlay-header {
    position: absolute; /* Change to absolute */
    top: 0; /* Position at top of layout */
    left: 0;
    width: 100%;
    box-sizing: border-box !important;
  }

  /* --- Three-column layout proportions for print --- */
  div[style*="display: flex; height: 140px"] {
    height: 120px !important; /* Slightly smaller for print */
  }
  
  /* Left column (dropdowns) - maintain 430px width */
  div[style*="width: 430px"] {
    width: 430px !important;
    flex-shrink: 0 !important;
  }
  
  /* Middle column (canvas) - maintain flex: 1 behavior but with constraints */
  div[style*="flex: 1"][style*="position: relative"] {
    flex: 1 !important;
    min-width: 300px !important;
    max-width: 500px !important;
  }
  
  /* Right column (textarea) - maintain 420px width */  
  div[style*="width: 420px"] {
    width: 420px !important;
    margin-left: auto !important;
  }
  
  /* Canvas should fill its container properly */
  #drawing-canvas {
    width: 100% !important;
    height: 100% !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
  }
  
  /* Hide the mode button in print */
  #text-tool-btn {
    display: none !important;
  }

  #imageContainer img {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    top: auto !important;
    right: auto !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
    object-position: bottom left !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* --- REMOVE DEBUG STYLE --- */
  /* 
    * {
      outline: 1px solid red !important;
      box-sizing: border-box;
    } 
  */
}
      @page {
        size: landscape;
        margin: 0.5cm;
      }
      body {
        font-family: Arial, sans-serif;
        font-size: 16px;
        margin: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
        /* Reduce top padding to bring content closer to the top */
        padding: 8px 8px 20px 8px;
        display: flex;
        flex-direction: column;
        background-color: rgb(233, 215, 215); /* Change background to white */
        color: rgb(19, 17, 17); /* Ensure text is visible on white background */
      }
      #layout {
        border: none;
        padding: 0;
        width: 100%;
        max-width: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        border-radius: 10px;
        margin: 0;
        /* align items from the top */
        justify-content: flex-start; /* This is the key change */
        flex: 1;
      }
      /* .controls {
        margin-bottom: 0;
        width: 1268px;
        box-sizing: border-box;
        margin: 0 auto;
      } */
      #textInput {
        width: 98%;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-size: 13px;
        resize: vertical;
        min-width: 100px;
        max-width: 98%;
        max-height: 200px;
      }
      /* Fixed target image area to match imported image dimensions exactly (increased by 10%) */
      /* Change this rule (around line 114) */
      #imageContainer {
        width: 100%;
        max-width: none;
        background: #f9f9f9;
        overflow: hidden;
        margin: 0;
        position: relative;
        box-sizing: border-box;
        padding: 0 !important;
        display: flex;
        align-items: flex-end;
        justify-content: flex-end;
        /* Add this line to make it fill available vertical space */
        flex-grow: 1;
      }

      /* overlay header positioned over the image area */
      .overlay-header {
        position: absolute;
        top: 8px;
        left: 12px;
        right: 0;
        z-index: 100; /* Increased from 10 to 100 to ensure it's on top */
        color: #222;
        font-weight: bold;
        pointer-events: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        overflow: visible;
        height: auto; /* Allow the container to expand with content */
      }
      .top-header-row {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding-right: 20px; /* Adjust this to fine-tune right-side spacing */
      }
      .overlay-textarea {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 2px 8px 8px;
        background-color: white;
        border: 1px solid #e5e0e0;
        outline: none;
        border-radius: 10px;
        text-align: left;
        color: black;
        margin-bottom: 2px;
        height: 20px;
        min-height: 20px;
        max-height: 20px;
        overflow: hidden;
        resize: none;
      }
      #datetimeHeader {
        max-width: 900px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: left; /* Ensure title alignment matches text */
      }
      .top-bar {
        width: 98%;
        margin: 0 auto 10px auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
      }
      img {
        filter: none !important; /* Cancel the invert colors functionality */
      }
      #imageContainer img {
        width: 100% !important; /* Fill container width */
        /* height: 100% !important; Fill container height */
        object-fit: contain !important; /* Show entire image proportionally */
        object-position: left !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important; /* Align to top-left for full coverage */
        right: auto !important;
        bottom: auto !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      .field-row {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        gap: 4px;
      }
      .field-label {
        min-width: 70px;
        font-size: 13px;
        color: #222;
      }
      .field-select {
        width: 72px;
        height: 20px;
        border: 1px solid #e5e0e0;
        border-radius: 10px;
        background-color: white;
        color: black;
        font-size: 13px;
        padding: 0 4px;
        outline: none;
      }
      .field-select:focus {
        border-color: #aaa;
      }

      /* Make the four left textareas half width */
      #toFindInput,
      #measureInput,
      #ofSizeInput,
      #fromInput {
        flex: 0 0 50%;
        width: 50%;
      }

      /* Make all small textareas 50px wide */
      textarea[style*="width: 50px"] {
        width: 50px !important;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background-color: #2e2e2e;
          color: #e0e0e0;
        }
        .overlay-header {
          color: #1d1c1c; /* Black text for contrast on bright background */
        }
        .field-label {
          color: #221e1e; /* Black text for labels */
        }
        .overlay-textarea {
          background-color: #fff; /* White background for textareas */
          color: #242121; /* Black text */
          border: 1px solid #e5e0e0;
        }
        .overlay-textarea:focus {
          background-color: #f0f0f0;
        }
        #imageContainer {
          background: #f9f9f9; /* Bright background */
          border: 1px dashed #ede9e9;
        }
      }
    </style>

  </head>
  <body>
    <!-- header moved to overlay inside #layout to free vertical space -->
    <!-- <div class="controls"> -->
      <!-- Removed duplicate text input -->
    </div>
    <div id="layout">
      <!-- overlay header sits on top of image area -->
      <div class="overlay-header">
  <div style="display: flex; height: 140px; min-height: 140px; width: 100%; box-sizing: border-box; gap: 0;">
          <!-- Left column -->
          <div style="width: 430px; flex-shrink: 0;">
            <div class="field-row">
              <label for="toFindInput" class="field-label">To Find:</label>
              <!-- <textarea id="toFindInput" class="overlay-textarea"></textarea> -->
              <select class="field-select">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
            </div>
            <div class="field-row">
              <label for="measureInput" class="field-label">Measure:</label>
              <!-- <textarea id="measureInput" class="overlay-textarea"></textarea> -->
              <select class="field-select">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
            </div>
            <div class="field-row">
              <label for="ofSizeInput" class="field-label">Of Size:</label>
              <!-- <textarea id="ofSizeInput" class="overlay-textarea"></textarea> -->
              <select class="field-select">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
            </div>
            <div class="field-row">
              <label for="fromInput" class="field-label">From:</label>
              <!-- <textarea id="fromInput" class="overlay-textarea"></textarea> -->
              <select class="field-select">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
            </div>
            <div class="field-row">
              <span class="field-label">Comment:</span>
              <!-- <textarea class="overlay-textarea" rows="1"></textarea> -->
              <select class="field-select">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
              <select class="field-select" style="margin-left: 8px;">
                <option value=""></option>
                <option value="QtWt">QtWt</option>
                <option value="WtEt">WtEt</option>
                <option value="EtRt">EtRt</option>
                <option value="RtTt">RtTt</option>
                <option value="TtYt">TtYt</option>
                <option value="YtUt">YtUt</option>
                <option value="UtPt">UtPt</option>
                <option value="PtAt">PtAt</option>
                <option value="AtSt">AtSt</option>
                <option value="StDt">StDt</option>
                <option value="DtFt">DtFt</option>
                <option value="FtGt">FtGt</option>
                <option value="GtHt">GtHt</option>
                <option value="HtJt">HtJt</option>
                <option value="JtKt">JtKt</option>
                <option value="LtZt">LtZt</option>
                <option value="ZtCt">ZtCt</option>
                <option value="CtVt">CtVt</option>
                <option value="VtBt">VtBt</option>
                <option value="BtNt">BtNt</option>
                <option value="NtMt">NtMt</option>
              </select>
              <textarea style="width: 50px; height: 20px; border: 1px solid #e5e0e0; border-radius: 10px; background-color: white; color: black; font-size: 13px; padding: 0 4px; outline: none; resize: none; box-sizing: border-box; font-family: Arial, sans-serif; margin-left: 4px;"></textarea>
            </div>
          </div>
          <!-- Spacer column for canvas -->
          <div style="flex: 1; position: relative; border: 1px solid #ddd; background-color: #f9f9f9;">
            <canvas id="drawing-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
            <button id="text-tool-btn" style="position: absolute; bottom: 7px; left: 7px; width: 15px; height: 15px; border: 1px solid #ccc; background: white; font-size: 10px; font-weight: bold; cursor: pointer; border-radius: 2px; padding: 0; margin: 0; display: flex; align-items: center; justify-content: center;">L</button>
          </div>
          <!-- Right column -->
          <div style="min-width: 0; padding-right: 20px; padding-left: 15px; display: flex; flex-direction: column; width: 420px; margin-left: auto;">
            <div class="top-header-row" style="padding-right: 0px; margin-bottom: 6px; padding-top: 4px;">
              <div
                id="datetimeHeader"
                contenteditable="true"
                spellcheck="false"
                title="Click to edit."
                style="
                  font-size: 0.77em;
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  padding-right: 20px;
                "
              ></div>
              <div id="date-under-commentary" class="field-label" style="padding-right: 0px;"></div>
            </div>
            <textarea id="rightBigField" spellcheck="true" lang="en" data-enable-grammarly="true" data-gramm="true" contenteditable="true" style="width: 100%; flex: 1; resize: none; margin: 0; box-sizing: border-box; border: 1px solid #e5e0e0; border-radius: 10px; padding: 8px; font-family: Arial, sans-serif; font-size: 12px; background-color: white; color: black;"></textarea>
          </div>
      <style>
        .fields-row {
          display: flex;
          flex-direction: row;
          gap: 24px;
          width: 100%;
          height: 260px;
          min-height: 200px;
          align-items: stretch;
        }
        .fields-col {
          display: flex;
          flex-direction: column;
          gap: 6px;
          flex: 1 1 0%;
          height: 100%;
        }
        .right-fields-col {
          height: 100%;
        }
        .right-stretch {
          flex: 1 1 0%;
          min-height: 0;
          height: 100%;
          width: 100%;
        }
      </style>
        </div>
      </div>
      <!-- Removed textPreview -->
      <div id="imageContainer" style="position: relative"></div>
      <!-- Add Save Data button below the image container -->
      <!-- <div style="margin-top: 10px; text-align: center"></div> -->
    </div>
    <script>
      console.log("Main window renderer script loaded");
      console.log("electronAPI available:", !!window.electronAPI);
      console.log(
        "Main window renderer script loaded, electronAPI available:",
        !!window.electronAPI
      );
      const imageContainer = document.getElementById("imageContainer");
      const datetimeHeader = document.getElementById("datetimeHeader");

      // Trigger Browse Image on click anywhere in image area
      // imageContainer.addEventListener("click", () => {
      //   window.electronAPI.openImageDialog();
      // });

      let isHeaderEdited = false;
      function getDefaultHeaderText() {
        const now = new Date();
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sept",
          "Oct",
          "Nov",
          "Dec",
        ];
        const dayAbbr = days[now.getDay()];
        const monthAbbr = months[now.getMonth()];
        const dayOfMonth = now.getDate();
        const nyOptions = {
          timeZone: "America/New_York",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };
        const nyTime = now.toLocaleTimeString("en-US", nyOptions);
        return `${dayAbbr} ${monthAbbr} ${dayOfMonth} | ${nyTime}`;
      }
      function updateDatetimeHeader() {
        if (!isHeaderEdited) {
          datetimeHeader.textContent = getDefaultHeaderText();
        }
      }
      updateDatetimeHeader();
      setInterval(updateDatetimeHeader, 10000);

      function setDateUnderCommentary() {
        const dateElement = document.getElementById("date-under-commentary");
        if (dateElement) {
          dateElement.textContent = "Printed: " + getDefaultHeaderText();
          dateElement.style.fontWeight = "normal";
        }
      }
      setDateUnderCommentary();
      setInterval(setDateUnderCommentary, 10000);

      datetimeHeader.addEventListener("input", () => {
        isHeaderEdited = true;
      });
      datetimeHeader.addEventListener("blur", () => {
        // If user clears the header, restore default
        if (datetimeHeader.textContent.trim() === "") {
          isHeaderEdited = false;
          updateDatetimeHeader();
        }
      });

      // Listen for menu-triggered Browse Image
      window.electronAPI.onMenuBrowseImage(() => {
        window.electronAPI.openImageDialog();
      });

      // Listen for menu Print -> save as PDF (main process will then open print dialog)
      window.electronAPI.onMenuPrint(() => {
        // call preload's saveAsPDF handler; options can be passed if needed
        window.electronAPI.saveAsPDF({}).then?.(() => {});
      });

      // When main notifies PDF saved, trigger print dialog from renderer (allowed)
      window.electronAPI.onPDFSaved((event, result) => {
        if (result && result.success) {
          // call native print dialog from renderer context
          try {
            window.print();
          } catch (e) {
            console.error("window.print failed", e);
          }
        } else {
          console.error("PDF save failed", result && result.error);
        }
      });

      // Listen for menu Snip -> start snipping tool via main
      window.electronAPI.onMenuSnip(() => {
        window.electronAPI.startSnip();
      });

      // Listen for selected image path from main process
      window.electronAPI.onImageSelected((event, filePath) => {
        imageContainer.innerHTML = "";
        if (filePath) {
          const img = new Image();
          img.src = `file://${filePath}`;
          img.onload = () => {
            img.style.width = "auto";
            img.style.height = "100%";
            img.style.objectFit = "contain";
            img.style.objectPosition = "center";
            imageContainer.appendChild(img);
          };
        }
      });

      // Listen for paste event to insert clipboard image
      window.addEventListener("paste", (event) => {
        const items = event.clipboardData && event.clipboardData.items;
        if (!items) return;
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.type.indexOf("image") !== -1) {
            const blob = item.getAsFile();
            const img = new Image();
            const url = URL.createObjectURL(blob);
            img.src = url;
            img.onload = () => {
              imageContainer.innerHTML = "";
              img.style.width = "auto"; // Adjust to natural aspect ratio
              img.style.height = "100%"; // Fit height
              img.style.objectFit = "contain"; // Show entire image
              img.style.objectPosition = "center"; // Center if needed
              imageContainer.appendChild(img);
            };
            break;
          }
        }
      });

      // Listen for snip image from main process
      window.electronAPI.onSnipImage = (callback) => {
        window.electronAPI._snipImageHandler = (event, imageUrl) =>
          callback(imageUrl);
        window.electronAPI._snipImageListener =
          window.electronAPI._snipImageListener ||
          window.electronAPI._snipImageHandler;
        window.electronAPI._ipcRenderer =
          window.electronAPI._ipcRenderer || require("electron").ipcRenderer;
        window.electronAPI._ipcRenderer.on(
          "snip-image",
          window.electronAPI._snipImageListener
        );
      };
      window.electronAPI.onSnipImage((imageUrl) => {
        if (imageUrl) {
          imageContainer.innerHTML = "";
          const imgObj = new window.Image();
          imgObj.src = imageUrl;
          imgObj.onload = function () {
            const aspectRatio = imgObj.naturalWidth / imgObj.naturalHeight;
            const containerWidth = imageContainer.offsetWidth;
            const containerHeight = imageContainer.offsetHeight;
            let newWidth = containerWidth;
            let newHeight = newWidth / aspectRatio;
            if (newHeight < containerHeight) {
              newHeight = containerHeight;
              newWidth = newHeight * aspectRatio;
            }
            if (newWidth > containerWidth) {
              newWidth = containerWidth;
              newHeight = newWidth / aspectRatio;
            }
            const wrapper = document.createElement("div");
            wrapper.className = "crop-wrapper";
            wrapper.style.left = (containerWidth - newWidth) / 2 + "px";
            wrapper.style.top = containerHeight - newHeight + "px";
            wrapper.style.width = newWidth + "px";
            wrapper.style.height = newHeight + "px";
            wrapper.style.position = "absolute";
            wrapper.style.zIndex = "2";
            const img = document.createElement("img");
            img.src = imageUrl;
            img.className = "crop-img";
            img.draggable = false;
            wrapper.appendChild(img);
            const handle = document.createElement("div");
            handle.className = "resize-handle";
            wrapper.appendChild(handle);
            imageContainer.appendChild(wrapper);
          };
        }
      });

      // Ensure print styles override inline styles during printing
      function applyPrintImageStyles() {
        const imgs = imageContainer.querySelectorAll("img");
        imgs.forEach((img) => {
          img.style.width = "";
          img.style.height = "";
          img.style.objectFit = "";
          img.style.objectPosition = "";
          img.style.position = "";
          img.style.right = "";
          img.style.bottom = "";
          img.style.left = "";
          img.style.top = "";
          img.style.margin = "";
          img.style.padding = "";
        });
        
        // Redraw canvas with print scaling
        if (window.redrawCanvas) {
          window.redrawCanvas();
        }
      }
      
      function restoreScreenStyles() {
        // Redraw canvas with normal scaling
        if (window.redrawCanvas) {
          window.redrawCanvas();
        }
      }
      
      window.addEventListener("beforeprint", applyPrintImageStyles);
      window.addEventListener("afterprint", restoreScreenStyles);

      function padZero(num) {
        return num < 10 ? "0" + num : num;
      }
      function getFormattedDateTime() {
        const now = new Date();
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sept",
          "Oct",
          "Nov",
          "Dec",
        ];
        const dayName = days[now.getDay()];
        const monthName = months[now.getMonth()];
        const dayNum = now.getDate();
        const ny = new Date(
          now.toLocaleString("en-US", { timeZone: "America/New_York" })
        );
        const nyHour = padZero(ny.getHours());
        const nyMin = padZero(ny.getMinutes());
        const il = new Date(
          now.toLocaleString("en-US", { timeZone: "Asia/Jerusalem" })
        );
        const ilHour = padZero(il.getHours());
        const ilMin = padZero(il.getMinutes());
        return `${dayName} ${monthName} ${dayNum} | ${nyHour}:${nyMin} | Israel: ${ilHour}:${ilMin}`;
      }

      function syncDateTitleLabel() {
        var dateTitleLabel = document.getElementById("dateTitleLabel");
        var datetimeHeader = document.getElementById("datetimeHeader");
        if (dateTitleLabel && datetimeHeader) {
          dateTitleLabel.textContent = datetimeHeader.textContent;
        }
      }
      window.addEventListener("DOMContentLoaded", function () {
        syncDateTitleLabel();
      });
      if (datetimeHeader) {
        datetimeHeader.addEventListener("input", syncDateTitleLabel);
      }
      setInterval(syncDateTitleLabel, 10000);

      function copyDateTitle() {
        var originalDateTitle = document.getElementById("datetimeHeader");
        var copiedDateTitle = document.getElementById("copiedDateTitle");
        if (originalDateTitle && copiedDateTitle) {
          copiedDateTitle.textContent = originalDateTitle.textContent;
        }
      }
      window.addEventListener("DOMContentLoaded", function () {
        copyDateTitle();
      });
      if (datetimeHeader) {
        datetimeHeader.addEventListener("input", copyDateTitle);
      }
      setInterval(copyDateTitle, 10000);

      window.addEventListener("DOMContentLoaded", () => {
        // Enable spell check for all textareas
        document.querySelectorAll('textarea').forEach(textarea => {
          textarea.setAttribute('spellcheck', 'true');
          textarea.setAttribute('lang', 'en');
          // Force spell check refresh
          textarea.addEventListener('input', function() {
            this.spellcheck = true;
          });
        });
        console.log("DOM loaded in main window");
        if (window.electronAPI) {
          console.log("Attaching onSelectedEntry listener");
          window.electronAPI.onSelectedEntry((entry) => {
            console.log("Received entry in main window:", entry);
            const toFindEl = document.getElementById("toFindInput");
            if (toFindEl) {
              toFindEl.value = (entry.toFind || "").replace(/^To Find:\s*/, "");
            }
            const measureEl = document.getElementById("measureInput");
            if (measureEl) {
              measureEl.value = (entry.measure || "").replace(
                /^Measure:\s*/,
                ""
              );
            }
            const ofSizeEl = document.getElementById("ofSizeInput");
            if (ofSizeEl) {
              ofSizeEl.value = (entry.ofSize || "").replace(/^Of Size:\s*/, "");
            }
            const fromEl = document.getElementById("fromInput");
            if (fromEl) {
              fromEl.value = (entry.from || "").replace(/^From:\s*/, "");
            }
            const commentEl = document.querySelector(
              ".field-row:last-child textarea"
            );
            if (commentEl) {
              commentEl.value = entry.comment || "";
            }
            // Populate the title
            const datetimeHeader = document.getElementById("datetimeHeader");
            if (datetimeHeader) {
              datetimeHeader.textContent = entry.title || "";
              isHeaderEdited = true; // Prevent the auto-update interval from resetting it
            }
          });
        } else {
          console.error("electronAPI not available in main window");
        }
      });

      // Listen for menu-triggered save
      window.electronAPI.onTriggerSaveData(() => {
        const data = {
          toFind: document.getElementById("toFindInput")?.value || "",
          measure: document.getElementById("measureInput")?.value || "",
          ofSize: document.getElementById("ofSizeInput")?.value || "",
          from: document.getElementById("fromInput")?.value || "",
          comment: document.querySelector(".field-row:last-child textarea")?.value || "",
          printed: document.getElementById("date-under-commentary").textContent,
          title: document.getElementById("datetimeHeader").textContent,
          timestamp: new Date().toISOString(),
        };
        window.electronAPI.saveData(data);
      });
    </script>
  <style>
    :root {
      --col-gap: 8px;
      --col-width: 63px; /* column width for dropdowns and headers (10% smaller) */
    }
    /* Normalize spacing for first row and all rows */
    .field-row {
      gap: var(--col-gap); /* uniform gap between controls */
      display: flex;
      flex-wrap: nowrap; /* prevent wrap causing misalignment */
      align-items: center; /* vertical alignment */
    }
    .field-row .field-select {
      margin-left: 0 !important; /* override any inline margins; rely on gap */
      width: var(--col-width);
    }
    .field-row textarea {
      width: 50px !important; /* ensure tiny textareas stay 50px */
      height: 20px !important;
      margin-left: 0 !important; /* rely on gap */
    }
    /* Ensure compact dropdowns match visual size */
    .field-select {
      height: 22px;
      line-height: 22px;
    }
    /* Prevent the first inline textarea (the very small one) from collapsing */
    .overlay-textarea {
      width: 50px !important;
      height: 20px !important;
    }

    /* Header labels above the six dropdown columns */
    .columns-header {
      display: flex;
      gap: var(--col-gap);
      align-items: center;
      margin: 4px 0 6px 0;
      user-select: none;
    }
    .columns-header .col-head {
      display: inline-block;
      width: var(--col-width);
      text-align: center;
      font-size: 11px;
      color: #666;
      letter-spacing: 0.3px;
    }
  </style>
  <script>
  // Remove only the small 50px textareas that immediately follow dropdowns
    document.addEventListener('DOMContentLoaded', function () {
      // Remove left-side labels to free space: To Find, Measure, Of Size, From, Comment
      const labelsToRemove = new Set(['To Find:', 'Measure:', 'Of Size:', 'From:', 'Comment:']);
      document.querySelectorAll('.field-row .field-label').forEach(function (el) {
        const txt = (el.textContent || '').trim();
        if (labelsToRemove.has(txt)) {
          el.remove();
        }
      });

      document.querySelectorAll('.field-row select + textarea').forEach(function (el) {
        el.remove();
      });

      // Also remove any remaining tiny 50px textareas inside rows (even if placed before a select)
      document.querySelectorAll('.field-row textarea').forEach(function (el) {
        const w = parseFloat(getComputedStyle(el).width || '0');
        if (w && w <= 60) {
          el.remove();
        }
      });

      // Ensure each row has 6 dropdowns; append missing ones at the end of the row
      const options = [
        '', 'QtWt','WtEt','EtRt','RtTt','TtYt','YtUt','UtPt','PtAt','AtSt','StDt','DtFt','FtGt','GtHt','HtJt','JtKt','LtZt','ZtCt','CtVt','VtBt','BtNt','NtMt'
      ];

      function createSelect() {
        const sel = document.createElement('select');
        sel.className = 'field-select';
        options.forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          sel.appendChild(opt);
        });
        return sel;
      }

      document.querySelectorAll('.field-row').forEach(function (row) {
        // Ignore rows that contain a large right-side textarea container
        const selects = row.querySelectorAll('select.field-select');
        const need = 6 - selects.length;
        for (let i = 0; i < need; i++) {
          row.appendChild(createSelect());
        }
      });

      // Ensure every select has a Custom option for inline editing
      document.querySelectorAll('select.field-select').forEach(function (sel) {
        if (!Array.from(sel.options).some(o => o.value === '__custom__')) {
          const opt = document.createElement('option');
          opt.value = '__custom__';
          opt.textContent = 'Custom';
          sel.appendChild(opt);
        }
      });

      // Attach handler to show an inline input when Custom is chosen
      document.querySelectorAll('select.field-select').forEach(function (sel) {
        sel.addEventListener('change', function () {
          if (sel.value === '__custom__') {
            // Create input positioned in-flow to preserve layout
            const input = document.createElement('input');
            input.type = 'text';
            input.value = '';
            input.placeholder = 'Type value';
            input.style.width = getComputedStyle(sel).width;
            input.style.height = getComputedStyle(sel).height;
            input.style.border = getComputedStyle(sel).border;
            input.style.borderRadius = getComputedStyle(sel).borderRadius;
            input.style.padding = '0 4px';
            input.style.fontSize = getComputedStyle(sel).fontSize;
            input.style.outline = 'none';
            // Insert just before select, hide select temporarily
            sel.style.display = 'none';
            sel.parentNode.insertBefore(input, sel);
            input.focus();

            function commit() {
              const val = input.value.trim();
              if (val) {
                // If option with same text exists, select it; else add a new option
                let existing = Array.from(sel.options).find(o => o.value === val);
                if (!existing) {
                  const newOpt = document.createElement('option');
                  newOpt.value = val;
                  newOpt.textContent = val;
                  sel.insertBefore(newOpt, sel.options[sel.options.length - 1]); // before Custom
                  existing = newOpt;
                }
                sel.value = existing.value;
              } else {
                sel.value = '';
              }
              input.remove();
              sel.style.display = '';
              sel.dispatchEvent(new Event('change', { bubbles: true }));
            }

            input.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') commit();
              if (e.key === 'Escape') { input.remove(); sel.style.display=''; sel.value=''; }
            });
            input.addEventListener('blur', commit);
          }
        });
      });

      // Insert day labels header above the first row, aligned with the six columns
      if (!document.querySelector('.columns-header')) {
        const firstRow = document.querySelector('.field-row');
        if (firstRow) {
  const firstSelect = firstRow.querySelector('select.field-select');
          const header = document.createElement('div');
          header.className = 'columns-header';
          ['Fr', 'Mon', 'Tue', 'Wed', 'Thu', 'Fr'].forEach(function (d) {
            const span = document.createElement('span');
            span.className = 'col-head';
            span.textContent = d;
            header.appendChild(span);
          });

          // Insert header before the first row
          firstRow.parentNode.insertBefore(header, firstRow);

          // Align header with the first select's left edge
          if (firstSelect) {
            const rowRect = firstRow.getBoundingClientRect();
            const selRect = firstSelect.getBoundingClientRect();
            const leftPad = Math.max(0, Math.round(selRect.left - rowRect.left));
            header.style.paddingLeft = leftPad + 'px';
          }
        }
      }
    });
  </script>
  </body>
  <script>
  // Fix: After choosing a custom value, ensure the dropdown is usable again
  // Date: 2025-09-27
  (() => {
    const CUSTOM_VALUE = '__custom__';
    const CUSTOM_LABEL = 'Custom';

    function ensureCustomOption(select) {
      if (!select) return;
      const hasCustom = Array.from(select.options).some(o => o.value === CUSTOM_VALUE);
      if (!hasCustom) {
        const opt = new Option(CUSTOM_LABEL, CUSTOM_VALUE);
        select.add(opt);
      }
    }

    function findOption(select, value) {
      return Array.from(select.options).find(o => o.value === value);
    }

    function openCustomEditor(select) {
      if (!select || select.dataset.editing === '1') return;
      select.dataset.editing = '1';

      const previous = select.dataset.prevValue || '';

      // Create an input exactly where the select is
      const input = document.createElement('input');
      input.type = 'text';
      input.value = '';
      input.setAttribute('data-role', 'custom-editor');

      // Size and style to match select dimensions
      const rect = select.getBoundingClientRect();
      const style = getComputedStyle(select);
      input.style.width = rect.width + 'px';
      input.style.height = rect.height + 'px';
      input.style.boxSizing = 'border-box';
      input.style.font = style.font;
      input.style.padding = style.padding;
      input.style.margin = style.margin;

      // Insert right after the select and hide the select
      select.insertAdjacentElement('afterend', input);
      select.hidden = true;

      const cleanup = () => {
        input.remove();
        select.hidden = false;
        select.dataset.editing = '';
        // Return focus to the select so the user can immediately open it again
        select.focus();
      };

      const commit = () => {
        const typed = input.value.trim();
        // If nothing typed, just cancel
        if (!typed) {
          cancel();
          return;
        }

        // Make sure the "Custom" option still exists for future edits
        ensureCustomOption(select);

        // Add or reuse an option matching the typed value
        let opt = findOption(select, typed);
        if (!opt) {
          opt = new Option(typed, typed);
          // Place before the custom option if present, else append
          const customOpt = findOption(select, CUSTOM_VALUE);
          if (customOpt && customOpt.parentElement === select) {
            select.add(opt, customOpt);
          } else {
            select.add(opt);
          }
        }

        // Select the typed value
        select.value = typed;

        cleanup();
        // Fire change to notify any listeners
        select.dispatchEvent(new Event('change', { bubbles: true }));
      };

      const cancel = () => {
        // Restore previous value if it still exists, else clear selection
        if (previous && findOption(select, previous)) {
          select.value = previous;
        } else {
          // Fallback: if custom exists, move back to it; otherwise first option
          const customOpt = findOption(select, CUSTOM_VALUE);
          select.value = customOpt ? CUSTOM_VALUE : (select.options[0]?.value ?? '');
        }
        cleanup();
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          commit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancel();
        }
      });
      input.addEventListener('blur', () => {
        // Commit on blur for a smoother UX
        commit();
      });

      input.focus();
      input.select();
    }

    // Ensure every select has the Custom option available
    document.querySelectorAll('select.field-select').forEach(ensureCustomOption);

    // Use a delegated change listener in capture phase. If user chooses Custom, we intercept
    // and open the inline editor, then stop other handlers from acting on the temporary state.
    document.addEventListener('change', (ev) => {
      const target = ev.target;
      if (!(target instanceof HTMLSelectElement)) return;
      if (!target.classList.contains('field-select')) return;
      if (target.value !== CUSTOM_VALUE) return;

      // Remember previous value so we can restore on cancel
      target.dataset.prevValue = target.dataset.prevValue ?? '';
      // If the user had a real value before choosing Custom, store it
      const current = target.options[target.selectedIndex]?.value;
      if (current && current !== CUSTOM_VALUE) {
        target.dataset.prevValue = current;
      }

      // Open editor and prevent further propagation of this change
      openCustomEditor(target);
      ev.stopImmediatePropagation();
      ev.stopPropagation();
    }, true);
  })();
  </script>
  <script>
    // Canvas drawing functionality
    (() => {
      const canvas = document.getElementById('drawing-canvas');
      const modeButton = document.getElementById('text-tool-btn');
      if (!canvas || !modeButton) return;
      
      const ctx = canvas.getContext('2d');
      let lines = [];
      let texts = [];
      let isDrawing = false;
      let isDragging = false;
      let currentLine = null;
      let dragLine = null;
      let dragText = null;
      let dragOffset = { x: 0, y: 0 };
      let mode = 'line'; // 'line' or 'text'
      
      // Set canvas size to match container
      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        redrawCanvas();
      }
      
      // Get precise cursor position relative to canvas
      function getCursorPos(e) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
      
      // Check if cursor is near a line (within 5 pixels)
      function getLineAtPosition(x, y) {
        for (let line of lines) {
          const distance = distanceToLine(x, y, line.startX, line.startY, line.endX, line.endY);
          if (distance <= 5) {
            return line;
          }
        }
        return null;
      }
      
      // Check if cursor is over a text label
      function getTextAtPosition(x, y) {
        for (let text of texts) {
          // Simple bounding box check (approximate text dimensions)
          const textWidth = ctx.measureText(text.content).width;
          const textHeight = 11; // font size
          if (x >= text.x - 2 && x <= text.x + textWidth + 2 &&
              y >= text.y - textHeight && y <= text.y + 2) {
            return text;
          }
        }
        return null;
      }
      
      // Calculate distance from point to line segment
      function distanceToLine(px, py, x1, y1, x2, y2) {
        const dx = x2 - x1;
        const dy = y2 - y1;
        const length = Math.sqrt(dx * dx + dy * dy);
        if (length === 0) return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);
        
        const t = Math.max(0, Math.min(1, ((px - x1) * dx + (py - y1) * dy) / (length * length)));
        const projX = x1 + t * dx;
        const projY = y1 + t * dy;
        return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
      }
      
      // Redraw all lines and text on canvas
      function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Determine if we're in print mode and scale accordingly
        const isPrinting = window.matchMedia('print').matches;
        const scaleFactor = isPrinting ? 3 : 1; // Scale up 3x for printing
        
        // Draw lines
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2 * scaleFactor;
        ctx.lineCap = 'round';
        for (let line of lines) {
          ctx.beginPath();
          ctx.moveTo(line.startX, line.startY);
          ctx.lineTo(line.endX, line.endY);
          ctx.stroke();
        }
        
        // Draw text labels with larger font for printing
        ctx.fillStyle = '#333';
        const fontSize = Math.round(11 * scaleFactor);
        ctx.font = `${fontSize}px Arial`;
        ctx.textBaseline = 'bottom';
        for (let text of texts) {
          ctx.fillText(text.content, text.x, text.y);
        }
      }
      
      // Custom text input function for Electron
      function showTextInput(x, y) {
        console.log('showTextInput called with:', x, y);
        
        // Create input element
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Enter text...';
        input.style.position = 'fixed';
        input.style.left = (canvas.getBoundingClientRect().left + x) + 'px';
        input.style.top = (canvas.getBoundingClientRect().top + y - 15) + 'px';
        input.style.zIndex = '10000';
        input.style.padding = '4px 8px';
        input.style.border = '2px solid #007acc';
        input.style.borderRadius = '4px';
        input.style.fontSize = '12px';
        input.style.background = 'white';
        input.style.outline = 'none';
        input.style.minWidth = '20px'; // Start small
        input.style.width = '20px'; // Start small
        input.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
        
        console.log('Input element created, adding to document');
        console.log('Input position - left:', input.style.left, 'top:', input.style.top);
        
        // Add to document
        document.body.appendChild(input);
        
        // Function to auto-resize input based on content
        function autoResize() {
          // Create a hidden span to measure text width
          const span = document.createElement('span');
          span.style.visibility = 'hidden';
          span.style.position = 'absolute';
          span.style.fontSize = '12px';
          span.style.fontFamily = 'Arial, sans-serif';
          span.style.whiteSpace = 'nowrap';
          span.textContent = input.value || input.placeholder;
          document.body.appendChild(span);
          
          const textWidth = span.offsetWidth;
          document.body.removeChild(span);
          
          // Set width with some padding
          input.style.width = Math.max(20, textWidth + 20) + 'px';
        }
        
        // Delay focus to ensure element is properly rendered
        setTimeout(() => {
          input.focus();
          input.select();
          autoResize(); // Initial resize
          console.log('Input focused after delay');
        }, 50);
        
        console.log('Input element added');
        
        // Handle input completion
        function completeInput() {
          const text = input.value.trim();
          console.log('Completing input with text:', text);
          if (text) {
            texts.push({
              x: x,
              y: y,
              content: text
            });
            console.log('Text added to texts array:', texts);
            redrawCanvas();
          }
          if (document.body.contains(input)) {
            document.body.removeChild(input);
            console.log('Input element removed');
          }
        }
        
        // Handle input cancellation
        function cancelInput() {
          console.log('Canceling input');
          if (document.body.contains(input)) {
            document.body.removeChild(input);
          }
        }
        
        // Event listeners
        input.addEventListener('keydown', (e) => {
          console.log('Key pressed:', e.key);
          if (e.key === 'Enter') {
            e.preventDefault();
            completeInput();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelInput();
          }
        });
        
        // Add click event to prevent canvas from receiving the click
        input.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Input clicked, preventing canvas click');
        });
        
        // Add input event to track typing and auto-resize
        input.addEventListener('input', (e) => {
          console.log('User typing:', e.target.value);
          autoResize();
        });
        
        // Add blur event to complete input when clicking outside
        input.addEventListener('blur', () => {
          console.log('Input lost focus, completing');
          completeInput();
        });
      }
      
      // Mode switching
      modeButton.addEventListener('click', () => {
        if (mode === 'line') {
          mode = 'text';
          modeButton.textContent = 'T';
          canvas.style.cursor = 'text';
          console.log('Switched to text mode');
        } else {
          mode = 'line';
          modeButton.textContent = 'L';
          canvas.style.cursor = 'crosshair';
          console.log('Switched to line mode');
        }
      });
      
      // Mouse down - start drawing, dragging, or add text
      canvas.addEventListener('mousedown', (e) => {
        const pos = getCursorPos(e);
        console.log('Canvas clicked at:', pos.x, pos.y, 'Mode:', mode);
        
        if (mode === 'line') {
          const nearLine = getLineAtPosition(pos.x, pos.y);
          if (nearLine) {
            // Start dragging existing line
            isDragging = true;
            dragLine = nearLine;
            dragOffset.x = pos.x - nearLine.startX;
            dragOffset.y = pos.y - nearLine.startY;
            canvas.style.cursor = 'move';
          } else {
            // Start drawing new line
            isDrawing = true;
            currentLine = {
              startX: pos.x,
              startY: pos.y,
              endX: pos.x,
              endY: pos.y
            };
          }
        } else if (mode === 'text') {
          const nearText = getTextAtPosition(pos.x, pos.y);
          if (nearText) {
            // Start dragging existing text
            isDragging = true;
            dragText = nearText;
            dragOffset.x = pos.x - nearText.x;
            dragOffset.y = pos.y - nearText.y;
            canvas.style.cursor = 'move';
            console.log('Dragging text:', nearText.content);
          } else {
            // Single click outside text - do nothing (wait for double click)
            console.log('Single click in empty area - waiting for double click');
          }
        }
      });
      
      // Double click handler for text mode
      canvas.addEventListener('dblclick', (e) => {
        if (mode === 'text') {
          const pos = getCursorPos(e);
          const nearText = getTextAtPosition(pos.x, pos.y);
          if (!nearText) {
            // Double click in empty area - add new text
            console.log('Double click - adding new text at:', pos.x, pos.y);
            showTextInput(pos.x, pos.y);
          }
        }
      });
      
      // Mouse move - draw line, drag line, or drag text
      canvas.addEventListener('mousemove', (e) => {
        const pos = getCursorPos(e);
        
        if (isDrawing && currentLine && mode === 'line') {
          // Update current line end position
          currentLine.endX = pos.x;
          currentLine.endY = pos.y;
          redrawCanvas();
          
          // Draw current line being drawn
          ctx.strokeStyle = '#666';
          ctx.beginPath();
          ctx.moveTo(currentLine.startX, currentLine.startY);
          ctx.lineTo(currentLine.endX, currentLine.endY);
          ctx.stroke();
        } else if (isDragging && dragLine && mode === 'line') {
          // Move the dragged line
          const deltaX = pos.x - dragOffset.x - dragLine.startX;
          const deltaY = pos.y - dragOffset.y - dragLine.startY;
          
          dragLine.startX += deltaX;
          dragLine.startY += deltaY;
          dragLine.endX += deltaX;
          dragLine.endY += deltaY;
          
          redrawCanvas();
        } else if (isDragging && dragText && mode === 'text') {
          // Move the dragged text
          dragText.x = pos.x - dragOffset.x;
          dragText.y = pos.y - dragOffset.y;
          redrawCanvas();
        } else {
          // Change cursor when hovering over elements
          if (mode === 'line') {
            const nearLine = getLineAtPosition(pos.x, pos.y);
            canvas.style.cursor = nearLine ? 'move' : 'crosshair';
          } else if (mode === 'text') {
            const nearText = getTextAtPosition(pos.x, pos.y);
            canvas.style.cursor = nearText ? 'move' : 'text';
          }
        }
      });
      
      // Mouse up - finish drawing or dragging
      canvas.addEventListener('mouseup', (e) => {
        if (isDrawing && currentLine && mode === 'line') {
          // Finish drawing line
          lines.push(currentLine);
          currentLine = null;
          isDrawing = false;
          redrawCanvas();
        }
        
        if (isDragging) {
          isDragging = false;
          dragLine = null;
          dragText = null;
          canvas.style.cursor = mode === 'line' ? 'crosshair' : 'text';
        }
      });
      
      // Mouse leave - stop any current operation
      canvas.addEventListener('mouseleave', () => {
        if (isDrawing) {
          isDrawing = false;
          currentLine = null;
          redrawCanvas();
        }
        if (isDragging) {
          isDragging = false;
          dragLine = null;
          dragText = null;
        }
        canvas.style.cursor = mode === 'line' ? 'crosshair' : 'text';
      });
      
      // Initial setup
      canvas.style.cursor = 'crosshair';
      window.addEventListener('resize', resizeCanvas);
      setTimeout(resizeCanvas, 100); // Initial resize after DOM settles
      
      // Make redrawCanvas available globally for print handling
      window.redrawCanvas = redrawCanvas;
    })();
  </script>
  </html>
