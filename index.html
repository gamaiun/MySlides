<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>MySlide</title>
    <style>
      .print-title {
        display: none;
        font-size: 1.3em;
        font-weight: bold;
        color: #222;
        margin-bottom: 8px;
        text-align: center;
      }
      @media print {
        html,
        body {
          width: 100%;
          height: 100%;
          margin: 0 !important;
          padding: 0 !important;
          overflow: hidden !important;
        }
        #printBtn {
          visibility: hidden !important;
        }
        #datetimeHeader {
          display: block !important;
          position: static !important;
          margin-top: 0.5cm !important;
          margin-bottom: 0.3cm !important;
        }
        .controls {
          margin-bottom: 0.3cm !important;
        }
        #layout {
          width: 100% !important;
          height: 100% !important;
          max-width: 100% !important;
          max-height: 100% !important;
          min-height: 0 !important;
          margin: 0 !important;
          padding: 0 !important;
          box-sizing: border-box !important;
          display: flex !important;
          flex-direction: column !important;
        }
        #imageContainer {
          flex: 1 1 auto !important;
          width: 100% !important;
          height: 100% !important;
          max-width: 100% !important;
          max-height: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          box-sizing: border-box !important;
        }
      }
      @page {
        size: landscape;
        margin: 0.5cm;
      }
      body {
        font-family: Arial, sans-serif;
        font-size: 16px;
        margin: 20px;
      }
      #layout {
        border: none;
        padding: 0;
        min-height: 0;
        height: calc(100vh - 70px);
        position: relative;
        max-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .controls {
        margin-bottom: 0;
      }
      #textInput {
        width: 100%;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-size: 13px;
        resize: vertical;
        min-width: 100px;
        max-width: 100vw;
      }
      #imageContainer {
        flex: 1 1 auto;
        width: 100%;
        height: 100%;
        background: #f9f9f9;
        border: 1px dashed #bbb;
        overflow: hidden;
        margin: 0;
        min-height: 0;
        max-height: 100%;
        position: relative;
      }
      .crop-wrapper {
        position: absolute;
        user-select: none;
      }
      .crop-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        pointer-events: none;
      }
      .resize-handle {
        position: absolute;
        width: 14px;
        height: 14px;
        background: #fff;
        border: 2px solid #888;
        border-radius: 50%;
        right: -10px;
        bottom: -10px;
        cursor: se-resize;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="print-title">MySlide</div>
    <div style="margin-bottom: 10px">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <div
          id="datetimeHeader"
          style="
            font-size: 1.1em;
            color: #444;
            font-weight: bold;
            white-space: nowrap;
          "
          contenteditable="true"
          spellcheck="false"
          title="Click to edit."
        ></div>
        <button
          id="printBtn"
          style="font-size: 13px; padding: 4px 16px; margin-left: 12px"
        >
          Print
        </button>
      </div>
      <input
        type="text"
        id="textInput"
        placeholder="Enter your text here"
        style="
          width: 100%;
          box-sizing: border-box;
          font-family: Arial, sans-serif;
          font-size: 13px;
          margin-top: 8px;
        "
      />
    </div>
    <div class="controls">
      <!-- Removed duplicate text input -->
    </div>
    <div id="layout">
      <!-- Removed textPreview -->
      <div
        id="imageContainer"
        style="
          position: relative;
          min-height: 300px;
          background: #f9f9f9;
          border: 1px dashed #bbb;
          overflow: hidden;
        "
      ></div>
    </div>
    <script>
      // Print button functionality
      const printBtn = document.getElementById("printBtn");
      printBtn.addEventListener("click", async () => {
        printBtn.disabled = true;
        printBtn.textContent = "Saving...";
        try {
          const result = await window.electronAPI.saveAsPDF({});
          if (result && result.success) {
            printBtn.textContent = "Saved!";
            setTimeout(() => {
              printBtn.textContent = "Print";
              printBtn.disabled = false;
            }, 1200);
          } else {
            printBtn.textContent = "Error";
            setTimeout(() => {
              printBtn.textContent = "Print";
              printBtn.disabled = false;
            }, 1200);
          }
        } catch (err) {
          printBtn.textContent = "Error";
          setTimeout(() => {
            printBtn.textContent = "Print";
            printBtn.disabled = false;
          }, 1200);
        }
      });
      const textInput = document.getElementById("textInput");
      // No browseImageBtn, only menu event
      const imageContainer = document.getElementById("imageContainer");
      // Removed imageFileName reference
      const datetimeHeader = document.getElementById("datetimeHeader");

      // Trigger Browse Image on click anywhere in image area
      imageContainer.addEventListener("click", () => {
        window.electronAPI.openImageDialog();
      });

      let isHeaderEdited = false;
      function getDefaultHeaderText() {
        const now = new Date();
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const dayAbbr = days[now.getDay()];
        const nyOptions = {
          timeZone: "America/New_York",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };
        const nyTime = now.toLocaleTimeString("en-US", nyOptions);
        const ilOptions = {
          timeZone: "Asia/Jerusalem",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };
        const ilTime = now.toLocaleTimeString("en-US", ilOptions);
        return `${dayAbbr} | New York: ${nyTime} | Israel: ${ilTime}`;
      }
      function updateDatetimeHeader() {
        if (!isHeaderEdited) {
          datetimeHeader.textContent = getDefaultHeaderText();
        }
      }
      updateDatetimeHeader();
      setInterval(updateDatetimeHeader, 10000);

      datetimeHeader.addEventListener("input", () => {
        isHeaderEdited = true;
      });
      datetimeHeader.addEventListener("blur", () => {
        // If user clears the header, restore default
        if (datetimeHeader.textContent.trim() === "") {
          isHeaderEdited = false;
          updateDatetimeHeader();
        }
      });

      // Removed textPreview logic

      // Listen for menu-triggered Browse Image
      window.electronAPI.onMenuBrowseImage(() => {
        window.electronAPI.openImageDialog();
      });

      // Listen for selected image path from main process
      window.electronAPI.onImageSelected((event, filePath) => {
        imageContainer.innerHTML = "";
        if (filePath) {
          // Load image to get natural size
          const imgObj = new window.Image();
          imgObj.src = `file://${filePath}`;
          imgObj.onload = function () {
            const aspectRatio = imgObj.naturalWidth / imgObj.naturalHeight;
            // Get container width
            const containerWidth = imageContainer.offsetWidth;
            const newWidth = containerWidth;
            const newHeight = newWidth / aspectRatio;
            // Create wrapper with image fit to container width
            const wrapper = document.createElement("div");
            wrapper.className = "crop-wrapper";
            wrapper.style.left = "0px";
            wrapper.style.top = "0px";
            wrapper.style.width = newWidth + "px";
            wrapper.style.height = newHeight + "px";
            wrapper.style.position = "absolute";
            wrapper.style.zIndex = "2";

            // Create image
            const img = document.createElement("img");
            img.src = `file://${filePath}`;
            img.className = "crop-img";
            img.style.filter = "grayscale(100%) invert(100%)";
            img.draggable = false;
            wrapper.appendChild(img);

            // Add resize handle
            const handle = document.createElement("div");
            handle.className = "resize-handle";
            wrapper.appendChild(handle);

            imageContainer.appendChild(wrapper);

            // Drag logic for wrapper
            let isDragging = false,
              dragStartX = 0,
              dragStartY = 0,
              startLeft = 0,
              startTop = 0;
            wrapper.addEventListener("mousedown", function (e) {
              if (e.target === handle) return;
              isDragging = true;
              dragStartX = e.clientX;
              dragStartY = e.clientY;
              startLeft = parseInt(wrapper.style.left);
              startTop = parseInt(wrapper.style.top);
              if (isNaN(startLeft)) startLeft = 0;
              if (isNaN(startTop)) startTop = 0;
              document.body.style.userSelect = "none";
              window.addEventListener("mousemove", dragMove);
              window.addEventListener("mouseup", dragEnd);
            });
            function dragMove(e) {
              if (isDragging) {
                let dx = e.clientX - dragStartX;
                let dy = e.clientY - dragStartY;
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                if (isNaN(newLeft)) newLeft = 0;
                if (isNaN(newTop)) newTop = 0;
                wrapper.style.left = newLeft + "px";
                wrapper.style.top = newTop + "px";
              }
            }
            function dragEnd() {
              isDragging = false;
              document.body.style.userSelect = "";
              window.removeEventListener("mousemove", dragMove);
              window.removeEventListener("mouseup", dragEnd);
            }

            // Resize logic (aspect ratio locked, no max limit)
            let isResizing = false,
              resizeStartX = 0,
              resizeStartY = 0,
              startWidth = 0,
              startHeight = 0;
            handle.addEventListener("mousedown", function (e) {
              e.stopPropagation();
              isResizing = true;
              resizeStartX = e.clientX;
              resizeStartY = e.clientY;
              startWidth = wrapper.offsetWidth;
              startHeight = wrapper.offsetHeight;
              document.body.style.userSelect = "none";
              window.addEventListener("mousemove", resizeMove);
              window.addEventListener("mouseup", resizeEnd);
            });
            function resizeMove(e) {
              if (isResizing) {
                let dw = e.clientX - resizeStartX;
                let newWidth = Math.max(50, startWidth + dw);
                let newHeight = newWidth / aspectRatio;
                wrapper.style.width = newWidth + "px";
                wrapper.style.height = newHeight + "px";
              }
            }
            function resizeEnd() {
              isResizing = false;
              document.body.style.userSelect = "";
              window.removeEventListener("mousemove", resizeMove);
              window.removeEventListener("mouseup", resizeEnd);
            }
          };
        }
      });
    </script>
  </body>
</html>
